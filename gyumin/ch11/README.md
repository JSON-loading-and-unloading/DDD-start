# 11장 CQRS

## 11.1 단일 모델의 단점

* JPA를 사용할 때 상태 변경 기능을 구현하는 데 적합하지만, 조회 기능에 있어서 여러 애그리거트에 데이터를 가져오는 경우에는 구현이 복잡해질 수 있다.

## 11.2 CQRS

* 시스템이 제공하는 기능은 두 개로 나눌 수 있다.
  * 상태를 변경한다.
    * 현재 저장하고 있는 데이터를 변경하는 방식으로 구현
  * 상태 정보 조회
* 도메인 모델 관점에서 상태 변경 기능은 주로 한 애그리거트의 상태를 변경한다.
    * 상태를 변경하는 범위와 조회하는 범위가 정확하게 일치하지 않기 때문에 단일 모델로 구현하면 조회 기능이 복잡해진다.
* CQRS를 통해 상태 변경 기능과 조회 기능을 분리하면 조회 기능을 위한 모델을 별도로 구현할 수 있다.
* CQRS를 도입하면 쓰기와 읽기 데이터베이스를 분리할 수 있으며, 각각 다른 기술을 사용할 수 있다.
* 명령 모델과 조회 모델이 같은 기술을 사용할 수 있다.
  * jpa에서 @Subselect 어노테이션을 사용하면 조회 모델을 구현할 수 있다.
* 데이터베이스를 분리한다면 두 데이터베이스간 데이터 동기화는 이벤트를 활용해 처리할 수 있다.
  * 데이터 동기화 시간이 짧아야 한다면 동기 이벤트와 글로벌 트랜잭션을 통해 데이터 동기화를 처리할 수 있다.
  * 특정 시간 안에만 동기화가 되어야 한다면 비동기 이벤트를 사용할 수 있다.

### 11.2.1 웹과 CQRS

* 일반적인 웹 서비스는 상태를 변경하는 요청보다 상태를 조회하는 요청이 많다.
* 조회 성능을 올리기 위해서는 조회 전용 모델을 사용하는 것이 좋다. 이는 데이터를 캐싱하는 데 도움이 된다.

### 11.2.2 CQRS 장단점

* 장점
  * CQRS를 적용하면 명령 모델을 구현할 때 도메인 자체에 집중할 수 있다는 점이 있다.
  * 조회 성능을 향상 시키는데 유리한 장점도 있다.
    * 조회 단위로 캐시 기술을 적용할 수 있고,, 조회에 특화된 쿼리를 마음대로 사용할 수 있음
  * 조회 전용 모델을 사용하기 때문에 조회 성능을 높이기 위한 코드가 명령 모델에 영향을 주지 않음
* 단점
  * 구현해야할 코드가 많아짐
  * 더 많은 구현 기술이 필요함
    * 명령 모델과 조회 모델을 다른 구현 기술을 사용해서 구현하기도하고 경우에 따라 다른 저장소를 사용하기도 한다.