# 10장 이벤트

## 10.1 시스템 간 강결합 문제

* 외부 시스템간 연계 작업이 필요한 경우 트랜잭션 처리가 복잡해진다. 이러한 문제는 두 도메인의 바운디드 컨텍스트간 강결합 문제로 볼 수 있다.
  * 외부 서비스가 정상이 아닐 경우(롤백, 커밋?)
  * 외부 서비스의 응답 시간이 길어져 성능 저하
* 도메인간 강결합은 이벤트를 통해서 해결할 수 있다.

## 10.2 이벤트 개요

### 10.2.1 이벤트 관련

* 도메인 모델에 이벤트를 도입하려면 이벤트, 이벤트 생성 주체, 이벤트 디스패처, 이벤트 핸들러를 구현해야한다.
* 도메인 모델에서 이벤트 생성 주체는 엔티티, 밸류, 도메인 서비스와 같은 도메인 객체다.
* 이벤트 핸들러는 이벤트 생성 주체가 발생한 이벤트에 반응한다.
* 이벤트 생성 주체와 이벤트 핸들러를 연결해주는 것이 이벤트 디스패처다.

### 10.2.2 이벤트의 구성

### 10.2.3 이벤트 용도

* 이벤트는 트리거의 용도와 서로 다른 시스템간 데이터 동기화의 용도가 있다.
  * 트리거 : 도메인의 상태가 바뀔 때 다른 후처리가 필요한 경우
  * 데이터 동기화 : 도메인의 상태가 바뀔 때 다른 시스템에 동일한 상태를 전달해야 하는 경우

### 10.2.4 이벤트 장점

* 이벤트를 사용하면 서로 다른 도메인 로직이 섞이는 것을 방지할 수 있다.
* 이벤트 핸들러를 사용하면 기능 확장도 용이하다.
* 이벤트의 구성요소는 스프링을 사용한다면 다음과 같다.
  * 이벤트 : 이벤트 객체
  * 디스패처, Events: ApplicationEventPublisher
  * 핸들러: @EventListener

## 10.3 이벤트, 핸들러, 디스패처 구현

### 10.3.1 이벤트 클래스

* 이벤트 자체를 위한 상위 타입은 존재하지 않습니다.
* 모든 이벤트들이 가지는 공통 필드가 있다면 추상 클래스를 만들어 상속받아 사용할 수 있습니다.

### 10.3.2 Events 클래스와 ApplicationEventPublisher

### 10.3.3 이벤트 발생과 이벤트 핸들러

### 10.3.4 흐름 정리

## 10.4 동기 이벤트 처리 문제

이벤트를 사용하더라도 외부 서비스에 영향을 받는 문제가 남아 있을 수 있다.


```Java
@Transactional
public void cancel(OrderNo orderNo){
    Order order = findOrder(orderNo);
    order.cancel();
}

@Service
public class OrderCancelEventHandler{
    @EventListener
    public void handle(OrderCanceledEvent event){
        refundService.refund(event.getOrderNo());
    }
}
```


위 상황에서 이벤트 처리가 외부 시스템 호출로 인해 처리 시간이 길어진다면 시스템 성능 저하로 이어질 수 있다.

이를 이벤트를 비동기로 처리하거나 이벤트와 트랜잭션을 연계하여 처리하는 방법뿐이다.


## 10.5 비동기 이벤트 처리

* 로컬 핸들러로 비동기 실행하기
* 메시지 큐 사용
* 이벤트 저장소와 이벤트 포워더 사용
* 이벤트 저장소와 이벤트 API 사용

### 10.5.1 로컬 핸들러 비동기 실행

* @Async를 통해서 비동기로 이벤트 핸들러를 실행할 수 있다.

### 10.5.2 메시징 시스템을 이용한 비동기 구현

* 카프카와 같은 메시지 큐를 통해서도 구현할 수 있다.
* 이벤트를 처리할 때, 글로벌 트랜잭션을 사용하여 안전하게 처리할 수 있지만, 이를 지원하지 않는 메시징 큐도 존재하기에 유의해야 한다.

### 10.5.3 이벤트 저장소를 이용한 비동기 처리

* 이벤트 저장소를 통해서 이벤트를 저장하고, 이벤트를 처리하는 시스템이 이벤트 저장소에서 이벤트를 가져와 처리할 수 있다.


## 10.6 이벤트 적용 시 추가 고려 사항

* 이벤트를 사용할 때 다음과 같은 고려사항이 있다.
  * 앞선 이벤트 저장소의 EventEntry에 이벤트 소스를 추가할지 여부
  * 포워더에서 전송 실패를 얼마나 허용할지
  * 이벤트 손실
  * 이벤트 순서
  * 이벤트 재처리

### 10.6.1 이벤트 처리와 DB 트랜잭션 고려

* 이벤트 처리를 위한 트랜잭션과 DB 트랜잭션을 어떻게 연계할지 고려해야 한다.
* 스프링의 @TransactionalEventListener를 사용하면 이벤트 처리를 DB 트랜잭션과 연계할 수 있다.