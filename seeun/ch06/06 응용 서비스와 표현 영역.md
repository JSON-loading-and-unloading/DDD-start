# 06 응용 서비스와 표현 영역

## 6.1 표현 영역과 응용 영역

- 표현 영역은 사용자의 요청을 해석해서 사용자가 실행하고 싶은 기능을 판별하고 그 기능을 제공하는 응용 서비스를 실행한다.
- 응용 서비스는 기능을 실행하는 데 필요한 입력 값을 메서드 인자로 받고 실행 결과를 리턴한다.
- 응용 서비스의 메서드가 요구하는 파라미터와 표현 영역이 사용자로부터 전달받은 데이터는 형식이 일치하지 않기 때문에 표현 영역은 응용 서비스가 요구하는 형식으로 사용자의 요청을 변환한다.
- 응용 서비스를 실행한 뒤에 표현 영역은 실행 결과를 사용자에게 알맞은 형식으로 응답한다.
- 사용자와 상호작용은 표현 영역이 처리하기 때문에 응용 서비스는 표현 영역에 의존하지 않는다.

## 6.2 응용 서비스의 역할

- 응용 서비스는 사용자가 요청한 기능을 실행한다. 응용 서비스는 사용자의 요청을 처리하기 위해 리포지터리에서 도메인 객체를 가져와 사용한다.
- 응용 서비스는 주로 도메인 객체 간의 흐름을 제어한다.
- 응용 서비스가 복잡하다면 응용 서비스에서 도메인 로직의 일부를 구현하고 있을 가능성이 높다. 응용 서비스가 도메인 로직의 일부를 구현하면 코드 중복, 로직 분산 등 코드 품질에 안 좋은 영향을 줄 수 있다.
- 응용 서비스는 트랜잭션 처리도 담당하여 도메인의 상태 변경을 트랜잭션으로 처리한다.

### 도메인 로직 넣지 않기

- 도메인 로직은 도메인 영역에 위치하고 응용 서비스는 도메인 로직을 구현하지 않는다.
- 도메인 로직을 도메인 영역과 응용 서비스에 분산해서 구현하면 코드 품질에 문제가 발생한다.
    - 코드의 응집성이 떨어진다.
    - 여러 응용 서비스에서 동일한 도메인 로직을 구현할 가능성이 높아진다.

## 6.3 응용 서비스의 구현

- 응용 서비스는 표현 영역과 도메인 영역을 연결하는 매개체 역할을 하는데 이는 디자인 패턴에서 파사드와 같은 역할을 한다.

### 응용 서비스의 크기

- 응용 서비스 자체의 구현은 어렵지 않지만 몇 가지 생각할 거리가 있다. 그중 하나가 응용 서비스의 크기다.

**예시 : 회원 도메인**

- 응용 서비스는 회원 가입, 탈퇴, 암호 변경, 비밀번호 초기화 등의 기능을 구현하기 위해 도메인 모델을 사용하게 된다. 이 경우 보통 두 가지 방법 중 한 가지 방식으로 구현된다.
    1. 한 응용 서비스 클래스에 회원 도메인의 모든 기능 구현하기
    2. 구분되는 기능별로 응용 서비스 클래스를 따로 구현하기
- 1번 방법으로 구현하면 한 도메인과 관련된 기능을 구현한 코드가 한 클래스에 위치하므로 각 기능에서 동일 로직에 대한 코드 중복을 제거할 수 있다는 장점이 있다. 그러나 한 서비스 클래스의 크기다 커진다는 단점이 있다.
    - 코드 크기가 커지면 연관성이 적은 코드가 한 클래스에 함께 위치할 가능성이 높아지게 되는데 결과적으로 관련 없는 코드가 뒤섞여 코드를 이해하는 데 방해가 된다.
- 2번 방법으로 구현하면 클래스 개수는 많아지지만 한 클래스에 관련 기능을 모두 구현하는 것과 비교해서 코드 품질을 일정 수준으로 유지하는 데 도움이 된다. 또한 각 클래스별로 필요한 의존 객체만 포함하므로 다른 기능을 구현한 코드에 영향을 받지 않는다.

### 응용 서비스의 인터페이스와 클래스

- 응용 서비스를 구현할 때 논쟁이 될 만한 것이 인터페이스가 필요한 지이다.
- 인터페이스가 필요한 몇 가지 상황이 있는데 그 중 하나는 구현 클래스가 여러 개인 경우다. 구현 클래스가 다수 존재하거나 런타임에 구현 객체를 교체해야 할 때 인터페이스를 유용하게 사용할 수 있다.
    - 그런데 응용 서비스는 런타임에 교체하는 경우가 거의 없고 한 응용 서비스의 구현 클래스가 두 개인 경우도 드물기에 인터페이스가 명확하게 필요하게 전까지는 응용 서비스에 대한 인터페이스를 작성하는 것이 좋은 선택이라고 볼 수는 없다.

### 메서드 파라미터와 값 리턴

- 응용 서비스가 제공하는 메서드는 도메인을 이용해서 사용자가 요구한 기능을 실행하는 데 필요한 값을 파라미터로 전달받아야 한다.
- 응용 서비스에서 애그리거트 자체를 리턴하면 도메인의 로직 실행을 응용 서비스와 표현 영역 두 곳에서 할 수 있게 되어 코드의 응집도를 낮추는 원인이 된다.

### 표현 영역에 의존하지 않기

- 응용 서비스의 파라미터 타입을 결정할 때 주의할 점은 표현 영역과 관련된 타입을 사용하면 안 된다는 점이다.
- 응용 서비스에서 표현 영역에 대한 의존이 발생하면 응용 서비스만 단독으로 테스트하기가 어려워진다. 게다가 표현 영역의 구현이 변경되면 응용 서비스의 구현도 함께 변경해야 하는 문제도 발생한다.
- 또한 응용 서비스가 표현 영역의 역할까지 대신하는 상황이 벌어질 수도 있다.

### 트랜잭션 처리

- 트랜잭션을 관리하는 것은 응용 서비스의 중요한 역할이다.

## 6.4 표현 영역

- 표현 영역의 책임은 다음과 같다.
    - 사용자가 시스템을 사용할 수 있는 흐름을 제공하고 제어한다.
    - 사용자의 요청을 알맞은 응용 서비스에 전달하고 결과를 사용자에게 제공한다.
    - 사용자의 세션을 관리한다.

## 6.5 값 검증

- 값 검증은 표현 영역과 응용 서비스 두 곳에서 모두 수행할 수 있다. 원칙적으로 모든 값에 대한 검증은 응용 서비스에서 처리한다.
- 표현 영역에서 사용자 입력을 검사하게 되면 표현 영역 코드가 다소 번잡해진다.
- 응용 서비스에서 입력 값을 검사하게 되면 좋지 않은 사용자 경험을 제공한다.
    - 값을 검사하는 시점에 첫 번째 값이 올바르지 않아 익셉션을 발생 시키면 나머지 항목에 대해서는 값을 검사하지 않게 되어 나머지 항목에 대해서는 값이 올바른지 알 수 없게 된다.
    - 이는 사용자가 같은 폼에 값을 여러 번 입력하게 만든다.
- 응용 서비스에서 사용자 불편을 해소하는 방법으로 에러 코드를 모아 하나의 익셉션으로 발생시키는 방법도 있다.
- 표현 영역에서는 필수 값, 값 형식, 범위 등을 검증하고 응용 서비스에선 논리적 오류를 검증하게할 수도 있다

## 6.6 권한 검사

- 개발하는 시스템마다 권한의 복잡도가 다르다.
- 이 다양한 상황을 충족할 수 있는 스프링 시큐리티 같은 프레임워크는 유연하고 확장 가능한 구조를 가지고 있다.
    - 유연한 만큼 복잡하기 때문에 이해가 부족하면 직접 권한 기능을 구현하는 것이 유지 보수에 더 유리할 수 있다.
- 보안 프레임워크 복잡도를 떠나 표현, 응용, 도메인 계층에서 권한 검사를 수행할 수 있다.
- 표현 영역에서 할 수 있는 기본적인 검사는 인증된 사용자인지 아닌지를 검사하는 것이다. 이런 접근 제어를 하기에 좋은 위치가 서블릿 필터이다.
- URL 만으로 접근 제어를 할 수 없는 경우 응용 서비스의 메서드 단위로 권한 검사를 수행해야 한다.
- 개별 도메인 객체 단위로 권한 검사를 해야 하는 경우는 구현이 복잡해진다.

## 6.7 조회 전용 기능과 응용 서비스

- 서비스에서 수행하는 추가적인 로직이 없고 단일 쿼리만 실행하는 조회 전용 기능이라면 트랜잭션이 필요하지 않다.
    - 이런 경우에는 굳이 서비스를 만들 필요 없이 표현 영역에서 바로 조회 전용 기능을 사용해도 문제가 없다.